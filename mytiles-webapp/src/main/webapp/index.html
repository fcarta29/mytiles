<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>MyTiles</title>
	<link rel="stylesheet" type="text/css" href="/css/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="/css/jquery-ui.structure.min.css">
    <style>
        #draggable359ac820-029f-11e5-b939-0800200c9a66 { 
            width: 150px;
            height: 150px; 
            padding: 0.5em;
            border: 1px solid red 
        }
        #draggable468dc560-029f-11e5-b939-0800200c9a66 { 
            width: 150px;
            height: 150px; 
            padding: 0.5em;
            border: 1px solid blue 
        }
        
    </style>
    <script src="/js/sockjs-0.3.4.js"></script>
    <script src="/js/stomp.js"></script>
    <script src="/js/jquery-2.1.4.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script type="text/javascript">
        var stompClient = null;
        
        $(function() {
        	$('#nameDiv').hide();
        	$('#conversationDiv').hide();
        	$( "#draggable359ac820-029f-11e5-b939-0800200c9a66" ).hide();
        	$( "#draggable468dc560-029f-11e5-b939-0800200c9a66" ).hide();
        	
        	$("#draggable359ac820-029f-11e5-b939-0800200c9a66").draggable({
        	    stop: function (event,ui) {
        	        sendTileMovement("359ac820-029f-11e5-b939-0800200c9a66",ui);	   
       	        }	
        	});
        	
        	$("#draggable468dc560-029f-11e5-b939-0800200c9a66").draggable({
        		stop: function (event,ui) {
                    sendTileMovement("468dc560-029f-11e5-b939-0800200c9a66",ui);     
                }
        	});
        	
            $("#connect").click(function() {
                connect();
            })
        	
            $("#disconnect").click(function() {
            	disconnect();
            })        	
        });

        function connect() {
            var socket = new SockJS('http://localhost:9090/mytiles/');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                setConnected(true);
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/tileUpdate', function(movement){
                	updateTileMovement(JSON.parse(movement.body));
                });
            });
        }

        function disconnect() {
            if (stompClient != null) {
                stompClient.disconnect();
            }
            setConnected(false);
            console.log("Disconnected");
        }

        function setConnected(connected) {
            $('#connect').prop('disabled',connected);
            $('#disconnect').prop('disabled',!connected);
            if (connected) {
            	$('#nameDiv').show();
            	$('#conversationDiv').show();
                $( "#draggable359ac820-029f-11e5-b939-0800200c9a66" ).show();
                $( "#draggable468dc560-029f-11e5-b939-0800200c9a66" ).show();
            } else {
            	$('#nameDiv').hide();
                $('#conversationDiv').hide();
                $( "#draggable359ac820-029f-11e5-b939-0800200c9a66" ).hide();
                $( "#draggable468dc560-029f-11e5-b939-0800200c9a66" ).hide();
            }
            $('#response').html('');            
        }

        function sendTileMovement(id,ui) {
            var name = $('#name').val();
            var now = new Date();
            stompClient.send("/app/tile/move", {}, JSON.stringify({ 
            	'tileId': id,
                'tileUserId': name,
                'tileTimestamp': now.getTime(),
                'tileX': ui.position.left,
                'tileY': ui.position.top,
                'tileZ': 0
            }));
        }

        function updateTileMovement(message) {
        	var draggable = $("#draggable" + message.tileId);
        	draggable.animate({
        		top: message.tileY,
        		left: message.tileX
     		}, 200);

        	draggable.find("#draggableMessage").text(message.tileUserId);
        	
            var response = $('#response');
            var p = document.createElement('p');
            p.style.wordWrap = 'break-word';
            p.appendChild(document.createTextNode(message.tileId 
            		+ ", " + message.tileUserId 
            		+ ", " + message.tileTimestamp
            	    + ", " + message.tileX
            	    + ", " + message.tileY
            	    + ", " +   message.tileZ));
            response.append(p);
        }
    </script>
</head>
<body>
<body onload="disconnect()">
<noscript><h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being enabled. Please enable
    Javascript and reload this page!</h2></noscript>
<div>
    <div>
        <button id="connect">Connect</button>
        <button id="disconnect" disabled="disabled">Disconnect</button>
    </div>
    <div id="nameDiv">
        <label>What is your name?</label><input type="text" id="name" />
    </div>
    <div id="draggable359ac820-029f-11e5-b939-0800200c9a66" class="ui-widget-content">
      <p>Funny Word</p>
      <p id="draggableMessage"></p>
    </div>
    <br/>
    <div id="draggable468dc560-029f-11e5-b939-0800200c9a66" class="ui-widget-content">
      <p>Halarious Word</p>
      <p id="draggableMessage"></p>
    </div>
    <div id="conversationDiv">
        <p id="response"></p>
    </div>          
</div>
</body>
</body>
</html>